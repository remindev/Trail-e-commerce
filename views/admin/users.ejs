<div class="search-cont">
    <input type="text" placeholder="search user">
    <button>search</button>
    <button onclick="addUser()">+ Add user</button>
</div>

<table class="table">
    <tr>
        <th class="col">#</th>
        <th class="col">Name</th>
        <th class="col">Email</th>
        <th class="col">Role</th>
        <th class="col">UID</th>
        <th class="col">Created</th>
        <th class="col">LastLogin</th>
        <th class="col">Order</th>
        <th class="col">Cart</th>
        <th class="col">-</th>
        <th class="col">-</th>
    </tr>

    <% users.forEach((user,index,array)=>{ %>

        <tr>
            <td>
                <%= index + 1 %>
            </td>
            <td>
                <%= user.name %>
            </td>
            <td>
                <%= user.email %>
            </td>
            <td>
                <%= user.admin.isAdmin?"A":"U"; %>
            </td>
            <td>
                <%= user.UID %>
            </td>
            <td>
                <%= user.creationTime %>
            </td>
            <td>
                <%= user.lastLoginTime %>
            </td>
            <td>
                <%= user.orders.length %>
            </td>
            <td>
                <%= user.cart.length %>
            </td>
            <td><img src="/res/edit-user.svg" alt="Edit" onclick="updatePopUp(1,this,true)" id="btn_of_the_button_UID"
                    identifier="<%=user.UID%>"></td>
            <td><img src="/res/delete.svg" alt=""></td>
        </tr>

        <% }); %>

</table>

<div class="update-user-form" id="update_user_field_main_cont" style="display: none;">

    <div class="canceler" id="cancler_popup" onclick="updatePopUp()">

    </div>

    <div class="edit-form">
        <h6><span>Edit -</span> <span id="user_data_edit_conformation">123@abc.com</span></h6>

        <p><b>Note :</b>&nbsp; You can leave feld empty if there is no updation</p>

        <div class="fields" id="update_user_fields">

            <div class="disp-error" style="display: none;">
                -
            </div>

            <div>
                <label for="name">Name <span class="err-disp"></span></label>
                <input type="text" name="name" autocomplete="off" placeholder="name" value="">
            </div>

            <div>
                <label for="emali">Email <span class="err-disp"></span></label>
                <input type="text" autocomplete="off" placeholder="email" value="">
            </div>

            <div>
                <label for="passord">Role ( <b>A</b> or <b>U</b> ) <span class="err-disp"></span></label>
                <input type="text" placeholder="Role" value="">
            </div>

            <div>
                <label for="password">password <span class="err-disp"></span></label>
                <input type="password" autocomplete="off" placeholder="new password" value="">
            </div>

            <div>
                <label for="password">conform <span class="err-disp"></span></label>
                <input type="password" autocomplete="off" placeholder="conform new passord" value="">
            </div>

            <div class="hidden">
                <input type="text" hidden id="hidden_input">
            </div>

            <div class="btn-cont">
                <button id="button_cancel_popup_remiver" onclick="updatePopUp()">Cancel</button>
                <button onclick="updateUser(this)">Update</button>
            </div>

        </div>

    </div>

</div>

<script>

    function updatePopUp(action, btn, add) {

        let doc = document.getElementById("update_user_field_main_cont");

        if (action) {

            doc.style.display = 'flex';

            if (add) {

                initlal(btn);

            };

        } else {
            doc.style.display = 'none';
        };

    };

    function initlal(button) {

        let docTo = document.getElementById("update_user_fields");

        let inputFieldsTo = docTo.querySelectorAll("input");

        let errElement = docTo.querySelector("div.disp-error");

        let UID = button.getAttribute('identifier');

        /** @type {Document} */
        let docFrom = button.parentElement.parentElement;

        let fieldsListFrom = docFrom.querySelectorAll("td");


        let buttons = docTo.querySelectorAll("button");


        let nameFrom = fieldsListFrom[1].innerText.trim();

        let emailFrom = fieldsListFrom[2].innerText.trim();

        let isAdminFrom = fieldsListFrom[3].innerText.trim();

        errElement.style.display = 'none';

        document.getElementById("user_data_edit_conformation").textContent = emailFrom;

        document.getElementById("hidden_input").value = UID;

        inputFieldsTo[0].setAttribute("placeholder", nameFrom);

        inputFieldsTo[0].value = '';

        inputFieldsTo[1].setAttribute("placeholder", emailFrom);

        inputFieldsTo[1].value = '';

        inputFieldsTo[2].setAttribute("placeholder", isAdminFrom);

        inputFieldsTo[2].value = '';

        inputFieldsTo[3].value = '';

        inputFieldsTo[4].value = '';



        buttons[1].innerText = 'Update';

        buttons[1].setAttribute('onclick', "updateUser(this)"); // TODO:WATCHOUT

    };

    function addUser() {

        updatePopUp(1);

        let formDoc = document.getElementById("update_user_fields");

        let fieldsListFrom = formDoc.querySelectorAll("input");

        let buttons = formDoc.querySelectorAll("button");


        let name = fieldsListFrom[0]

        let email = fieldsListFrom[1];

        let role = fieldsListFrom[2];

        let password = fieldsListFrom[3];

        let conform = fieldsListFrom[4];

        let good = true;

        document.getElementById("user_data_edit_conformation").textContent = 'Add user';

        buttons[1].innerText = 'Add User';

        buttons[1].setAttribute('onclick', "addUserFinal(this)");

    };

    async function addUserFinal() {

        let formDoc = document.getElementById("update_user_fields");

        let fieldsListFrom = formDoc.querySelectorAll("input");


        let name = fieldsListFrom[0]

        let email = fieldsListFrom[1];

        let role = fieldsListFrom[2];

        let password = fieldsListFrom[3];

        let conform = fieldsListFrom[4];

        let good = true;
        

        dispState(100);

        dispErr();


        function dispErr(message, good) {

            var doc = formDoc.querySelector("div.disp-error");

            if (message) {

                doc.style.backgroundColor = good ? "#d2ffd2" : "#ffd2d2";
                doc.textContent = message;

                doc.style.display = 'flex';

            } else {

                doc.style.display = 'none';

            };

        };

        function dispState(fieldNo, message) {

            if (fieldNo) {

                switch (fieldNo) {

                    case 1: {

                        let err = name.parentElement.querySelector("span.err-disp");

                        err.textContent = message;

                        break;

                    };

                    case 2: {

                        let err = email.parentElement.querySelector("span.err-disp");

                        err.textContent = message;

                        break;

                    };

                    case 3: {

                        let err = role.parentElement.querySelector("span.err-disp");

                        err.textContent = message;

                        break;

                    };

                    case 4: {

                        let err = password.parentElement.querySelector("span.err-disp");

                        err.textContent = message;

                        break;

                    };

                    case 5: {

                        let err = conform.parentElement.querySelector("span.err-disp");

                        err.textContent = message;

                        break;

                    };

                    default: {

                        for(let i=0; i<5; i++){

                            dispState((i+1),"");

                        };

                        break;

                    };

                };

            };

        };


        if (name.value.trim().length < 2) {

            dispState(1, "Enter a valid name");

            good = false;

        };

        if (!email.value.trim().toLocaleLowerCase().match(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/)) {

            dispState(2, 'Enter a valid email');

            good = false;

        };



        if (role.value.trim() == 'A' || role.value.trim() == 'U') {

            // good

        } else {

            dispState(3, 'Enter a valid Role');

            good = false;

        };


        if (password.value.trim().length < 6) {

            dispState(4, 'Enter a valid password');

            good = false;

        } else if (password.value.trim().length != 0) {

            if (conform.value.trim() == password.value.trim()) {



            } else {

                dispState(5, "Conform password dosn't match");

                good = false;

            }

        };

        if (good) {
            
            try {

                dispErr('Updating...', true);

                let res = await fetch('/admin/addUser',{
                    headers:{
                        'Content-Type': 'application/json'
                    },
                    method:"POST",
                    body:JSON.stringify({
                        email:email.value.toLocaleLowerCase(),
                        password:password.value,
                        name:name.value,
                        role:role.value,
                    })
                });

                let data = await res.json();

                if(data.status == 'error'){

                    dispErr(data.message);
                    
                }else{

                    document.getElementById("button_cancel_popup_remiver").setAttribute("onclick", 'window.location.reload()');
                    document.getElementById("cancler_popup").setAttribute("onclick", 'window.location.reload()');

                    dispErr(data.message,true);

                };

                
            } catch (error) {
              
                dispErr('Error creating user');
                
            };

        };

    }

    async function updateUser(button, addUser) {

        /** @type {Document} */
        let docFrom = button.parentElement.parentElement;

        let button_cancel = button.parentElement.querySelectorAll('button')[0];

        let fieldsListFrom = docFrom.querySelectorAll("input");

        let errElement = docFrom.querySelector("div.disp-error");

        let good = true;

        let name = fieldsListFrom[0]

        let email = fieldsListFrom[1];

        let role = fieldsListFrom[2];

        let password = fieldsListFrom[3];

        let conform = fieldsListFrom[4];

        let UID = document.getElementById("hidden_input").value;

        dispState(100);

        dispErr();

        function dispErr(message, good) {

            var doc = docFrom.querySelector("div.disp-error");

            if (message) {

                doc.style.backgroundColor = good ? "#d2ffd2" : "#ffd2d2";
                doc.textContent = message;

                doc.style.display = 'flex';

            } else {

                doc.style.display = 'none';

            };

        };

        function dispState(fieldNo, message) {

            if (fieldNo) {

                switch (fieldNo) {

                    case 1: {

                        let err = name.parentElement.querySelector("span.err-disp");

                        err.textContent = message;

                        break;

                    };

                    case 2: {

                        let err = email.parentElement.querySelector("span.err-disp");

                        err.textContent = message;

                        break;

                    };

                    case 3: {

                        let err = role.parentElement.querySelector("span.err-disp");

                        err.textContent = message;

                        break;

                    };

                    case 4: {

                        let err = password.parentElement.querySelector("span.err-disp");

                        err.textContent = message;

                        break;

                    };

                    case 5: {

                        let err = conform.parentElement.querySelector("span.err-disp");

                        err.textContent = message;

                        break;

                    };

                    default: {

                        fieldsListFrom.forEach((element, index, array) => {

                            if (index == array.length) {
                                element.parentElement.querySelector("span.err-disp").innerHTML = '';
                            };

                        });

                        break;

                    };

                };

            };

        };

        if (name.value.trim().length != 0 && name.value.trim().length < 2) {

            dispState(1, "Enter a valid name");

            good = false;

        };

        if (email.value.trim().length != 0 && !email.value.trim().match(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/)) {

            dispState(2, 'Enter a valid email');

            good = false;

        };

        if (role.value.trim().length != 0) {

            if (role.value.trim() == 'A' || role.value.trim() == 'U') {

                // good

            } else {

                dispState(3, 'Enter a valid Role');

                good = false;

            };

        };

        if (password.value.trim().length != 0 & password.value.trim().length < 6) {

            dispState(4, 'Enter a valid password');

            good = false;

        } else if (password.value.trim().length != 0) {

            if (conform.value.trim() == password.value.trim()) {



            } else {

                dispState(5, "Conform password dosn't match");

                good = false;

            }

        };

        if (good) {

            dispState(100);
            dispErr('Updating...', true);

            try {

                let res = await fetch('/admin/updateUser', {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    method: "POST",
                    body: JSON.stringify({

                        UID: UID.length == 25 ? UID : null,
                        name: name.value.length > 0 ? name.value.trim() : null,
                        email: email.value.length > 0 ? email.value.trim() : null,
                        role: role.value.trim() == 'A' || role.value.trim() == 'U' ? role.value.trim() : null,
                        password: password.value.trim().length >= 6 && conform.value.trim() == password.value.trim() ? password.value.trim() : null

                    })
                });

                let data = await res.json();

                if (data.status == 'error') {

                    dispErr(data.message);

                } else {

                    dispErr(data.message, true);

                    button_cancel.setAttribute("onclick", 'window.location.reload()');
                    document.getElementById("cancler_popup").setAttribute("onclick", 'window.location.reload()');

                };


            } catch (error) {
                console.error(error);
            };

        };


    };

</script>